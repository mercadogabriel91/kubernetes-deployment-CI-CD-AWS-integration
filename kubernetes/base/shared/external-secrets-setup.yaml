# External Secrets Operator Setup
# This syncs values from AWS Parameter Store to Kubernetes ConfigMaps/Secrets
# 
# INSTALLATION:
#   1. Install External Secrets Operator:
#      ./scripts/install-external-secrets.sh
#
#   2. Ensure Parameter Store has these parameters (created by Terraform):
#      - /k-challenge/aws/account-id
#      - /k-challenge/aws/region
#      - /k-challenge/aws/ecr-registry
#
#   3. Apply this file:
#      kubectl apply -f kubernetes/base/shared/external-secrets-setup.yaml

---
# SecretStore: Defines how to authenticate with AWS Parameter Store
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: aws-parameter-store
  namespace: k-challenge-namespace
spec:
  provider:
    aws:
      service: ParameterStore  # Use Parameter Store (not Secrets Manager)
      region: us-east-1
      # Authentication: Use static credentials from existing secret (for local K8s)
      # For EKS, use IRSA instead (see commented section below)
      auth:
        secretRef:
          accessKeyIDSecretRef:
            name: aws-credentials
            key: AWS_ACCESS_KEY_ID
          secretAccessKeySecretRef:
            name: aws-credentials
            key: AWS_SECRET_ACCESS_KEY
      # Alternative: Use Service Account with IRSA (for EKS)
      # Uncomment this and comment out secretRef above:
      # auth:
      #   jwt:
      #     serviceAccountRef:
      #       name: k-challenge-app-sa

---
# ExternalSecret: Syncs Parameter Store values to ConfigMap
# This creates a ConfigMap with ECR registry information
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: ecr-registry-config
  namespace: k-challenge-namespace
spec:
  refreshInterval: 1h  # Sync every hour (or when Parameter Store changes)
  secretStoreRef:
    name: aws-parameter-store
    kind: SecretStore
  target:
    name: ecr-registry-config
    creationPolicy: Owner
    # Create as ConfigMap (not Secret) since these are non-sensitive config values
    template:
      type: Opaque
      data:
        # Map Parameter Store values to ConfigMap keys
        AWS_ACCOUNT_ID: "{{ .aws_account_id }}"
        AWS_REGION: "{{ .aws_region }}"
        ECR_REGISTRY: "{{ .ecr_registry }}"
  data:
    # Fetch AWS Account ID from Parameter Store
    - secretKey: aws_account_id
      remoteRef:
        key: /k-challenge/aws/account-id
    
    # Fetch AWS Region from Parameter Store
    - secretKey: aws_region
      remoteRef:
        key: /k-challenge/aws/region
    
    # Fetch ECR Registry URL from Parameter Store (computed by Terraform)
    - secretKey: ecr_registry
      remoteRef:
        key: /k-challenge/aws/ecr-registry
