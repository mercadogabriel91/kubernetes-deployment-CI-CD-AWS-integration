# External Secrets Operator Setup for Argo CD Namespace
# This syncs ECR registry values from AWS Parameter Store to a ConfigMap in argocd namespace
# This ConfigMap is then used by Kustomize replacements to inject registry URLs into annotations
#
# INSTALLATION:
#   1. Ensure External Secrets Operator is installed:
#      ./scripts/install-external-secrets.sh
#
#   2. Ensure Parameter Store has these parameters (created by Terraform):
#      - /k-challenge/aws/account-id
#      - /k-challenge/aws/region
#      - /k-challenge/aws/ecr-registry
#
#   3. Configure Service Account for IRSA (IAM Roles for Service Accounts):
#      - Create Service Account for External Secrets Operator with IRSA annotation
#      - The Service Account should have eks.amazonaws.com/role-arn annotation
#      - This allows External Secrets Operator to use AWS IAM roles instead of static credentials
#
#   4. Apply this file:
#      kubectl apply -f kubernetes/base/shared/external-secrets-argocd-namespace.yaml

---
# SecretStore: Defines how to authenticate with AWS Parameter Store (in argocd namespace)
# Uses IRSA (IAM Roles for Service Accounts) for secure authentication
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: aws-parameter-store
  namespace: argocd
spec:
  provider:
    aws:
      service: ParameterStore
      region: us-east-1
      # Authentication: Use IRSA (IAM Roles for Service Accounts)
      # The Service Account running External Secrets Operator must have:
      #   annotations:
      #     eks.amazonaws.com/role-arn: <IAM_ROLE_ARN>
      # This is more secure than static credentials
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-operator
      # Alternative: Use static credentials (for local K8s or non-EKS clusters)
      # Uncomment this and comment out jwt above:
      # auth:
      #   secretRef:
      #     accessKeyIDSecretRef:
      #       name: aws-credentials
      #       key: AWS_ACCESS_KEY_ID
      #     secretAccessKeySecretRef:
      #       name: aws-credentials
      #       key: AWS_SECRET_ACCESS_KEY

---
# ExternalSecret: Syncs Parameter Store values to ConfigMap in argocd namespace
# This ConfigMap will be used by Kustomize to inject registry URLs into annotations
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: ecr-registry-config
  namespace: argocd
spec:
  refreshInterval: 1h # Sync every hour (or when Parameter Store changes)
  secretStoreRef:
    name: aws-parameter-store
    kind: SecretStore
  target:
    name: ecr-registry-config
    creationPolicy: Owner
    # Create as ConfigMap (not Secret) since these are non-sensitive config values
    template:
      type: Opaque
      data:
        # Map Parameter Store values to ConfigMap keys
        AWS_ACCOUNT_ID: "{{ .aws_account_id }}"
        AWS_REGION: "{{ .aws_region }}"
        ECR_REGISTRY: "{{ .ecr_registry }}"
        ARGOCD_IMAGE_UPDATER_ROLE_ARN: "{{ .argocd_image_updater_role_arn }}"
  data:
    # Fetch AWS Account ID from Parameter Store
    - secretKey: aws_account_id
      remoteRef:
        key: /k-challenge/aws/account-id

    # Fetch AWS Region from Parameter Store
    - secretKey: aws_region
      remoteRef:
        key: /k-challenge/aws/region

    # Fetch ECR Registry URL from Parameter Store (computed by Terraform)
    - secretKey: ecr_registry
      remoteRef:
        key: /k-challenge/aws/ecr-registry

    # Fetch Argo CD Image Updater IAM Role ARN from Parameter Store
    - secretKey: argocd_image_updater_role_arn
      remoteRef:
        key: /k-challenge/aws/argocd-image-updater-role-arn
