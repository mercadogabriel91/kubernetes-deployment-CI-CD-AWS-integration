name: Build and Push Docker Images

on:
  push:
    branches:
      - main
    paths:
      # Only trigger when application code changes, not infrastructure/config
      - "services/**/*"
      - ".dockerignore"
      - "Dockerfile*"
      - "**/Dockerfile*"
  workflow_dispatch: # Allow manual trigger

env:
  AWS_REGION: us-east-1

jobs:
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for OIDC
      contents: write # Required to commit kustomization.yaml changes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Get role ARN from GitHub secret (set from terraform output)
          # Run: terraform output -raw github_actions_role_arn
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID and Build ECR URLs
        id: ecr-urls
        run: |
          # Get AWS Account ID directly from AWS CLI (no Parameter Store needed)
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          AWS_REGION=${AWS_REGION:-us-east-1}

          # Build ECR repository URLs
          AUXILIARY_URL="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/k-challenge-dev-auxiliary-service"
          MAIN_API_URL="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/k-challenge-dev-main-api"

          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "aws_region=$AWS_REGION" >> $GITHUB_OUTPUT
          echo "auxiliary_url=$AUXILIARY_URL" >> $GITHUB_OUTPUT
          echo "main_api_url=$MAIN_API_URL" >> $GITHUB_OUTPUT

          echo "AWS Account ID: $ACCOUNT_ID"
          echo "AWS Region: $AWS_REGION"
          echo "Auxiliary Service ECR: $AUXILIARY_URL"
          echo "Main API ECR: $MAIN_API_URL"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Auxiliary Service
        uses: docker/build-push-action@v5
        with:
          context: ./services/auxiliary-service
          push: true
          tags: |
            ${{ steps.ecr-urls.outputs.auxiliary_url }}:latest
            ${{ steps.ecr-urls.outputs.auxiliary_url }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Main API
        uses: docker/build-push-action@v5
        with:
          context: ./services/main-api
          push: true
          tags: |
            ${{ steps.ecr-urls.outputs.main_api_url }}:latest
            ${{ steps.ecr-urls.outputs.main_api_url }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update kustomization.yaml with new image tags
        run: |
          COMMIT_SHA="${{ github.sha }}"
          
          # Update image tags in kustomization.yaml (registry URLs are already hardcoded)
          sed -i "s|newTag: latest|newTag: ${COMMIT_SHA}|g" kubernetes/overlays/dev/kustomization.yaml
          
          echo "✅ Updated kustomization.yaml with new image tags: ${COMMIT_SHA}"
          echo "  - Auxiliary Service: ${{ steps.ecr-urls.outputs.auxiliary_url }}:${COMMIT_SHA}"
          echo "  - Main API: ${{ steps.ecr-urls.outputs.main_api_url }}:${COMMIT_SHA}"

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add kubernetes/overlays/dev/kustomization.yaml

          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "chore: update image tags to ${{ github.sha }} [skip ci]"
            git push
            echo "✅ Pushed updated kustomization.yaml - Argo CD will auto-sync"
          else
            echo "ℹ️  No changes to commit"
          fi
