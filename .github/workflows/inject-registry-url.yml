# GitHub Action: Inject ECR Registry URL from Parameter Store
# This workflow replaces ${ECR_REGISTRY} placeholders in deployment annotations
# with actual values from AWS Parameter Store, ensuring no hardcoded account IDs in Git
#
# This runs on every push to main, ensuring Image Updater always sees the correct registry URL

name: Inject Registry URL

on:
  push:
    branches:
      - main
      paths:
        - "kubernetes/base/**/*.yaml"
        - "kubernetes/overlays/**/*.yaml"
        - "argocd/**/*.yaml"
  workflow_dispatch:

jobs:
  inject-registry:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write # For OIDC authentication

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get values from Parameter Store
        id: get-parameters
        run: |
          ECR_REGISTRY=$(aws ssm get-parameter \
            --name "/k-challenge/aws/ecr-registry" \
            --query 'Parameter.Value' \
            --output text)
          echo "registry=$ECR_REGISTRY" >> $GITHUB_OUTPUT
          echo "✅ ECR Registry: $ECR_REGISTRY"

          ROLE_ARN=$(aws ssm get-parameter \
            --name "/k-challenge/aws/argocd-image-updater-role-arn" \
            --query 'Parameter.Value' \
            --output text 2>/dev/null || echo "")
          if [ -n "$ROLE_ARN" ]; then
            echo "role_arn=$ROLE_ARN" >> $GITHUB_OUTPUT
            echo "✅ Image Updater Role ARN: $ROLE_ARN"
          else
            echo "⚠️  Image Updater Role ARN not found in Parameter Store"
          fi

      - name: Replace placeholders in deployment files
        run: |
          REGISTRY="${{ steps.get-parameters.outputs.registry }}"

          # Replace ${ECR_REGISTRY} in auxiliary-service deployment
          sed -i "s|\${ECR_REGISTRY}|${REGISTRY}|g" \
            kubernetes/base/auxiliary-service/auxiliary-service-deployment.yaml

          # Replace ${ECR_REGISTRY} in main-api deployment
          sed -i "s|\${ECR_REGISTRY}|${REGISTRY}|g" \
            kubernetes/base/main-api/main-api-deployment.yaml

          echo "✅ Placeholders replaced with: $REGISTRY"

      - name: Replace IAM role ARN placeholder in Service Account
        if: steps.get-parameters.outputs.role_arn != ''
        run: |
          ROLE_ARN="${{ steps.get-parameters.outputs.role_arn }}"

          # Replace ${ARGOCD_IMAGE_UPDATER_ROLE_ARN} in Service Account
          sed -i "s|\${ARGOCD_IMAGE_UPDATER_ROLE_ARN}|${ROLE_ARN}|g" \
            argocd/image-updater-service-account.yaml

          echo "✅ IAM Role ARN replaced with: $ROLE_ARN"

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

        - name: Commit changes
          if: steps.check-changes.outputs.changed == 'true'
          run: |
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add kubernetes/base/**/*.yaml argocd/**/*.yaml
            git commit -m "chore: inject ECR registry URL and IAM role ARN from Parameter Store [skip ci]"
            git push
